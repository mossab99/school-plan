name: Deploy WordPress Plugin to Contabo

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy WordPress Plugin via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
                    set -euxo pipefail
                    
                    BASE_DIR="/home/olama/htdocs/olama.online/wp-content/plugins"
                    PLUGIN_DIR="$BASE_DIR/School-Plan"
                    REPO_URL="https://github.com/mossab99/School-Plan.git"
                  
                    if [ ! -d "$BASE_DIR" ]; then
                      echo "ERROR: WordPress plugins directory not found"
                      exit 1
                    fi
                  
                    if [ ! -d "$PLUGIN_DIR" ]; then
                      echo "Plugin not found. Cloning repository..."
                      cd "$BASE_DIR"
                      git clone "$REPO_URL"
                    else
                      echo "Plugin directory exists. Updating repository..."
                      cd "$PLUGIN_DIR"
                  
                      git config --global --add safe.directory "$PLUGIN_DIR"
                  
                      if [ -d ".git" ]; then
                        git fetch origin
                        git reset --hard origin/main
                        git clean -fd
                      else
                        echo "Directory exists but is not a git repo. Re-cloning..."
                        cd "$BASE_DIR"
                        rm -rf "School-Plan"
                        git clone "$REPO_URL"
                      fi
                    fi

  chown -R www-data:www-data "$PLUGIN_DIR"
  find "$PLUGIN_DIR" -type d -exec chmod 755 {} \;
  find "$PLUGIN_DIR" -type f -exec chmod 644 {} \;
